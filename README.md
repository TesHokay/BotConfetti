# Confetti Telegram Bot

Телеграм-бот для студии преподавания французского языка «Конфетти». Проект реализован на Python с использованием библиотеки `python-telegram-bot` и хранением данных в SQLite.

## Возможности

### Для студентов
- Приветствие и главное меню с двуязычными разделами (русский/французский).
- Просмотр информации о студии, преподавателях, расписании и контактах.
- Запись на пробный урок с пошаговым диалогом: имя, контакт, желаемая дата, пожелания.
- Загрузка скриншота оплаты. Данные автоматически сохраняются в базе.

### Для администраторов
- Авторизация по списку `chat_id` (указать в `.env`).
- Панель администратора с кнопками:
  - Рассылка сообщений всем пользователям (копия исходного сообщения).
  - Просмотр заявок в табличном виде.
  - Редактирование текста разделов: расписание, о студии, преподаватели, контакты.
- Все заявки и платежи хранятся в SQLite и доступны для выгрузки.

## Структура проекта
```
BotConfetti/
├── bot_confetti/
│   ├── config.py
│   ├── database.py
│   ├── keyboards/
│   ├── messages.py
│   ├── services/
│   └── utils/
├── data/ (создаётся автоматически)
├── main.py
├── pyproject.toml
├── poetry.lock (создаётся локально после `poetry lock`)
├── requirements.txt
└── .env.example
```

## Подготовка окружения

1. Убедитесь, что Poetry установлен (проверка: `poetry --version`).
2. Создайте окружение и установите зависимости:
   ```bash
   poetry install
   ```
   При первом запуске команда автоматически создаст виртуальное окружение и
   установит все зависимости из `pyproject.toml`. Библиотека `python-telegram-bot`
   автоматически ставится с дополнительным модулем `rate-limiter`, чтобы работал
   встроенный ограничитель запросов. Для работы внутри окружения
   можно использовать `poetry shell` либо префикс `poetry run ...`.
3. (Опционально) Если требуется совместимость с `pip`, экспортируйте зависимости:
   ```bash
   poetry export --format requirements.txt --output requirements.txt
   ```
4. Скопируйте файл `.env.example` в `.env` и заполните значения:
   - `BOT_TOKEN` — токен бота от @BotFather.
   - `BOT_ADMIN_IDS` — список chat_id администраторов через запятую (узнать через @userinfobot).
   - при необходимости можно изменить путь к базе данных (`BOT_DATABASE`).

> ⚠️ **Ручные действия:**
> - Обязательно впишите актуальный `BOT_TOKEN` и `BOT_ADMIN_IDS` перед запуском.
> - После клонирования выполните `poetry lock`/`poetry install` на своём устройстве,
>   чтобы сформировать локальный `poetry.lock` (в репозитории он не сохранён из-за
>   ограничений окружения).

## Запуск

```bash
poetry run python main.py
```

или используйте консольную точку входа:

```bash
poetry run confetti-bot
```

Бот начнёт polling и готов к работе. Остановите сочетанием `Ctrl+C`.

## Работа с данными

- База данных расположена по умолчанию в `data/confetti.sqlite`.
- Таблицы: `users`, `bookings`, `payments`, `content`.
- Записи можно просматривать стандартными инструментами SQLite.

## Дополнительные заметки

- При рассылке бот копирует исходное сообщение администратора (текст/медиа) всем зарегистрированным пользователям.
- Даты заявок валидируются по формату `ДД.ММ.ГГГГ` без указания времени, как и требовалось.
- Контент разделов можно обновлять прямо из Телеграм через панель администратора.
- Экспорт заявок можно автоматически зеркалировать в облако: скопируйте
  сгенерированный XLSX в директорию, расшаренную через CDN или облачное
  хранилище, и отправляйте администраторам постоянную ссылку.

## Облачная таблица заявок

### Google Drive (рекомендуемый вариант)

1. Создайте сервисный аккаунт в Google Cloud Console и сохраните ключ:
   - либо в переменной `CONFETTI_GOOGLE_SERVICE_ACCOUNT_JSON` (строгое JSON-содержимое файла);
   - либо укажите путь к файлу в `CONFETTI_GOOGLE_SERVICE_ACCOUNT_FILE`.
2. Поделитесь папкой Google Drive с адресом сервисного аккаунта (почта вида `…@…iam.gserviceaccount.com`).
3. Выпишите идентификатор папки (часть URL после `/folders/`). Для примера выше это `1HQVWX3p41u2x2KHInWg__cX0LgqHgEBW`. Если переменная не указана, бот автоматически использует эту папку по умолчанию.
4. Пропишите переменные окружения:
   ```env
   CONFETTI_EXPORT_DRIVE_FOLDER_ID=1HQVWX3p41u2x2KHInWg__cX0LgqHgEBW
   CONFETTI_GOOGLE_SERVICE_ACCOUNT_FILE=/путь/к/key.json  # или JSON-строка в CONFETTI_GOOGLE_SERVICE_ACCOUNT_JSON
   # опционально:
   CONFETTI_EXPORT_CLOUD_FILENAME=confetti_registrations.xlsx  # фиксированное имя файла
   CONFETTI_EXPORT_DRIVE_SHARE_ANYONE=true                     # автоматически выдавать доступ по ссылке
   ```
5. Перезапустите бота. При каждой выгрузке XLSX будет загружаться прямо в указанную папку, обновляя один и тот же файл. В уведомлении администраторы получат постоянную ссылку `https://drive.google.com/file/d/<id>/view`.

### Локальная синхронизация (альтернатива)

Если у вас нет доступа к Google Drive API, можно оставить зеркалирование через синхронизируемый каталог. Подготовьте папку, которая автоматически отправляет содержимое в облако, и задайте переменные:

- `CONFETTI_EXPORT_CLOUD_DIR` — локальный путь к каталогу;
- `CONFETTI_EXPORT_CLOUD_URL` — публичный URL или CDN;
- `CONFETTI_EXPORT_CLOUD_FILENAME` (опционально) — фиксированное имя файла.

В этом режиме бот перезаписывает файл на диске и присылает ссылку `<CONFETTI_EXPORT_CLOUD_URL>/<имя файла>`.
